<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Chess.com</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f0f4f8;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
        color: #2c3e50;
      }
      #container {
        max-width: 1000px;
        margin: auto;
      }
      #players {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 30px;
      }
      select {
        padding: 10px 15px;
        font-size: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        cursor: pointer;
      }
      section {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        display: none;
      }
      h2 {
        margin-top: 0;
        color: #34495e;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: center;
      }
      th {
        background-color: #ecf0f1;
        font-weight: 600;
      }
      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
      }
      #loader {
        text-align: center;
        padding: 20px;
        font-size: 1.2em;
        display: none;
        color: #2980b9;
      }
      /* Online indicator */
      #onlineIndicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-left: 10px;
      }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <h1>Dashboard Chess.com</h1>
    <div id="container">
      <!-- Sélection -->
      <div style="text-align: center; margin-bottom: 20px">
        <label for="playerSelect"
          ><strong>Sélectionner un joueur : </strong></label
        >
        <select id="playerSelect"></select>
      </div>
      <!-- Loader -->
      <div id="loader">Chargement des données...</div>

      <!-- Sections -->
      <section id="profileSection">
        <h2>Profil</h2>
        <div id="profile"></div>
      </section>
      <section id="statusSection" style="margin-bottom: 20px">
        <h2>Status</h2>
        <div id="status"></div>
      </section>
      <section id="statsSection">
        <h2>Statistiques</h2>
        <div id="stats"></div>
      </section>
      <section id="gamesSection">
        <h2>Dernières parties</h2>
        <div id="games"></div>
      </section>
    </div>
    <script>
      const userList = [
        "hikaru",
        "fabianocaruana",
        "magnuscarlsen",
        "alireza",
        "animeboy",
        "elharicot",
        "bzhgrammaton",
        "jchprn",
        "blitzstream",
        "lowki93"
      ];

      const select = document.getElementById("playerSelect");
      const loader = document.getElementById("loader");
      const profileSection = document.getElementById("profileSection");
      const statusSection = document.getElementById("statusSection");
      const statsSection = document.getElementById("statsSection");
      const gamesSection = document.getElementById("gamesSection");

      function init() {
        userList.forEach((user) => {
          const option = document.createElement("option");
          option.value = user;
          option.textContent = user;
          select.appendChild(option);
        });
        fetchAllData(select.value);
      }

      function showLoader(show) {
        loader.style.display = show ? "block" : "none";
      }

      async function fetchAllData(username) {
        showLoader(true);
        profileSection.style.display = "none";
        statusSection.style.display = "none";
        statsSection.style.display = "none";
        gamesSection.style.display = "none";

        document.getElementById("profile").innerHTML = "";
        document.getElementById("status").innerHTML = "";
        document.getElementById("stats").innerHTML = "";
        document.getElementById("games").innerHTML = "";

        try {
          // Profil
          const profileRes = await fetch(
            `https://api.chess.com/pub/player/${username}`
          );
          if (!profileRes.ok) throw new Error("Profil non trouvé");
          const profileData = await profileRes.json();

          document.getElementById("profile").innerHTML = `
      <div style="display:flex; align-items:center; gap:20px;">
        <img src="${
          profileData.avatar
        }" alt="Avatar" style="width:100px; border-radius:50%;" />
        <div>
          <h3>${profileData.username}</h3>
          <p>Nom : ${profileData.name || "N/A"}</p>
          <p>Bio : ${profileData.bio || "N/A"}</p>
          <p>Localisation : ${profileData.location || "N/A"}</p>
        </div>
      </div>
    `;
          profileSection.style.display = "block";

          // Status (Online/Offline)
          fetch(`https://api.chess.com/pub/player/${username}/is-online`)
            .then((res) => res.json())
            .then((data) => {
              // debugger
              if (data.code === 0) return;
              const onlineStatusDiv = document.createElement("div");
              onlineStatusDiv.innerHTML = `Status : <strong>${
                data ? "En ligne" : "Hors ligne"
              }</strong>
          <span id="onlineIndicator" style="background-color:${
            data ? "green" : "red"
          }"></span>`;
              document.getElementById("status").innerHTML = "";
              document.getElementById("status").appendChild(onlineStatusDiv);
              document.getElementById("status").parentElement.style.display =
                "block";
            });

          // Stats
          const statsRes = await fetch(
            `https://api.chess.com/pub/player/${username}/stats`
          );
          const statsData = await statsRes.json();

          let statsHTML =
            "<table><tr><th>Mode</th><th>Win %</th><th>Rating</th><th>Meilleur</th></tr>";

          for (const key in statsData) {
            const stat = statsData[key];
            if (stat.last && stat.last.rating !== undefined) {
              const wins = stat.record ? stat.record.win : 0;
              const losses = stat.record ? stat.record.loss : 0;
              const draws =
                stat.record && stat.record.draw ? stat.record.draw : 0;
              const total = wins + losses + draws || 1;
              const winPercent = ((wins / total) * 100).toFixed(2);
              const bestLink =
                stat.best && stat.best.game
                  ? `<a href="${stat.best.game}" target="_blank">Voir</a>`
                  : "N/A";

              // Mode name
              let modeName = key;
              if (key.startsWith("chess_")) {
                modeName = key.slice(6); // enlever "chess_" prefix
              } else if (key === "chess_daily") modeName = "Daily";
              else if (key === "chess_rapid") modeName = "Rapide";
              else if (key === "chess_bullet") modeName = "Bullet";
              else if (key === "chess_blitz") modeName = "Blitz";

              statsHTML += `
        <tr>
          <td>${modeName}</td>
          <td>${winPercent}%</td>
          <td>${stat.last.rating}</td>
          <td>${bestLink}</td>
        </tr>`;
            }
          }
          statsHTML += "</table>";
          document.getElementById("stats").innerHTML = statsHTML;
          statsSection.style.display = "block";

          // Dernières parties
          const archivesRes = await fetch(
            `https://api.chess.com/pub/player/${username}/games/archives`
          );
          const archivesData = await archivesRes.json();

          if (archivesData.archives.length > 0) {
            const lastArchiveUrl =
              archivesData.archives[archivesData.archives.length - 1];
            const gamesRes = await fetch(lastArchiveUrl);
            const gamesData = await gamesRes.json();

            const recentGames = gamesData.games.slice(-15).reverse();

            let gamesHTML =
              "<table><tr><th>Date</th><th>Type de partie</th><th>Résultat</th><th>Opposant</th><th>Voir</th></tr>";

            recentGames.forEach((game) => {
              const date = new Date(game.end_time * 1000).toLocaleString();
              const isWhite = game.white.username.toLowerCase() === username;
              const result = isWhite ? game.white.result : game.black.result;
              const opponent = isWhite
                ? game.black.username
                : game.white.username;
              const time_class = game.time_class;
              const time_control = game.time_control / 60;
              const url = game.url;

              console.log({ username, isWhite, game, opponent });

              if (result === "TimeOut")
                console.log({ isWhite, game, result, opponent });

              let resText = "";
              let resClass = "";
              if (result === "win") {
                resText = "Victoire";
                resClass = "bg-green-100";
              }
              // else if (result === 'loss') resText = 'Défaite';
              else if (result === "draw") {
                resText = "Nulle";
                resClass = "bg-orange-100";
              } else if (result === "resigned") {
                resText = "Défaite (Abandon)";
                resClass = "bg-red-100";
              } else if (result === "timeout") {
                resText = "Défaite (TimeOut)";
                resClass = "bg-red-100";
              } else if (result === "checkmated") {
                resText = "Défaite (Echec et mat)";
                resClass = "bg-red-100";
              } else if (result === "abandoned") {
                resText = "Défaite (Abandon)";
                resClass = "bg-red-100";
              }

              gamesHTML += `
        <tr>
          <td>${date}</td>
          <td>${time_class} (${time_control} min)</td>
          <td class='${resClass}'' >${resText}</td>
          <td>${opponent}</td>
          <td><a href="${url}" target="_blank">Voir</a></td>
        </tr>`;
            });
            gamesHTML += "</table>";
            document.getElementById("games").innerHTML = gamesHTML;
            gamesSection.style.display = "block";
          } else {
            document.getElementById("games").innerHTML =
              "<p>Aucune partie trouvée.</p>";
            gamesSection.style.display = "block";
          }
        } catch (e) {
          alert("Erreur lors du chargement : " + e.message);
        } finally {
          showLoader(false);
        }
      }

      select.addEventListener("change", () => {
        fetchAllData(select.value);
      });

      window.onload = init;
    </script>
  </body>
</html>
