<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard Chess.com</title>

<!-- Google Fonts pour une typo moderne -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Roboto', sans-serif;
    background-color: #f0f4f8;
    margin: 0;
    padding: 20px;
    color: #333;
  }

  h1 {
    text-align: center;
    margin-bottom: 20px;
    color: #2c3e50;
  }

  #container {
    max-width: 1000px;
    margin: auto;
  }

  /* Sélection utilisateur */
  #players {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 30px;
  }

  select {
    padding: 10px 15px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    cursor: pointer;
  }

  /* Sections */
  section {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    display: none; /* caché par défaut, affiché quand données chargées */
  }

  h2 {
    margin-top: 0;
    color: #34495e;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 10px;
  }

  /* Tableau stylé */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    padding: 12px;
    border: 1px solid #ddd;
    text-align: center;
  }

  th {
    background-color: #ecf0f1;
    font-weight: 600;
  }

  /* Réactivité */
  @media(max-width: 600px){
    body {
      padding: 10px;
    }
  }

  /* Loader */
  #loader {
    text-align: center;
    padding: 20px;
    font-size: 1.2em;
    display: none;
    color: #2980b9;
  }
</style>
</head>
<body>

<h1>Dashboard Chess.com</h1>

<div id="container">
  <!-- Sélection utilisateur -->
  <div style="text-align:center; margin-bottom:20px;">
    <label for="playerSelect"><strong>Sélectionner un joueur : </strong></label>
    <select id="playerSelect"></select>
  </div>

  <!-- Loader -->
  <div id="loader">Chargement des données...</div>

  <!-- Profil -->
  <section id="profileSection">
    <h2>Profil</h2>
    <div id="profile"></div>
  </section>

  <!-- Statistiques -->
  <section id="statsSection">
    <h2>Statistiques</h2>
    <div id="stats"></div>
  </section>

  <!-- Dernières parties -->
  <section id="gamesSection">
    <h2>Dernières parties</h2>
    <div id="games"></div>
  </section>
</div>

<script>
  // const userList = [
  //   "hikaru", "fabianocaruana", "magnuscarlsen", "alireza", "animeboy", "elharicot", "bzhgrammaton", "jchprn"
  // ];

  // userList=[  "hikaru", "fabianocaruana", "magnuscarlsen", "alireza", "animeboy", "elharicot", "bzhgrammaton", "jchprn"]

  const select = document.getElementById('playerSelect');
  const loader = document.getElementById('loader');
  const profileSection = document.getElementById('profileSection');
  const statsSection = document.getElementById('statsSection');
  const gamesSection = document.getElementById('gamesSection');

  function init() {
    userList.forEach(user => {
      const option = document.createElement('option');
      option.value = user;
      option.textContent = user;
      select.appendChild(option);
    });
    fetchAllData(select.value);
  }

  function showLoader(show) {
    loader.style.display = show ? 'block' : 'none';
  }

  async function fetchAllData(username) {
    showLoader(true);
    profileSection.style.display = 'none';
    statsSection.style.display = 'none';
    gamesSection.style.display = 'none';

    document.getElementById('profile').innerHTML = '';
    document.getElementById('stats').innerHTML = '';
    document.getElementById('games').innerHTML = '';

    try {
      // Profil
      const profileRes = await fetch(`https://api.chess.com/pub/player/${username}`);
      if (!profileRes.ok) throw new Error('Profil non trouvé');
      const profileData = await profileRes.json();

      document.getElementById('profile').innerHTML = `
        <div style="display:flex; align-items:center; gap:20px;">
          <img src="${profileData.avatar}" alt="Avatar" style="width:100px; border-radius:50%;" />
          <div>
            <h3>${profileData.username}</h3>
            <p>Nom : ${profileData.name || 'N/A'}</p>
            <p>Bio : ${profileData.bio || 'N/A'}</p>
            <p>Localisation : ${profileData.location || 'N/A'}</p>
          </div>
        </div>
      `;
      profileSection.style.display = 'block';

      // Stats
      const statsRes = await fetch(`https://api.chess.com/pub/player/${username}/stats`);
      const statsData = await statsRes.json();

      let statsHTML = '<table><tr><th>Type</th><th>Win %</th><th>Rating</th></tr>';

      for (const key in statsData) {
        const stat = statsData[key];
        if (stat.last && stat.last.rating !== undefined) {
          const wins = stat.record ? stat.record.win : 0;
          const losses = stat.record ? stat.record.loss : 0;
          const draws = stat.record && stat.record.draw ? stat.record.draw : 0;
          const total = wins + losses + draws || 1;
          const winPercent = ((wins / total) * 100).toFixed(2);

          statsHTML += `
            <tr>
              <td>${key}</td>
              <td>${winPercent}%</td>
              <td>${stat.last.rating}</td>
            </tr>
          `;
        }
      }
      statsHTML += '</table>';
      document.getElementById('stats').innerHTML = statsHTML;
      statsSection.style.display = 'block';

      // Dernières parties
      const archivesRes = await fetch(`https://api.chess.com/pub/player/${username}/games/archives`);
      const archivesData = await archivesRes.json();

      if (archivesData.archives.length > 0) {
        const lastArchiveUrl = archivesData.archives[archivesData.archives.length - 1];
        const gamesRes = await fetch(lastArchiveUrl);
        const gamesData = await gamesRes.json();

        const recentGames = gamesData.games.slice(-5).reverse();

        let gamesHTML = '<table><tr><th>Date</th><th>Résultat</th><th>Opposant</th></tr>';

        recentGames.forEach(game => {
          const date = new Date(game.end_time * 1000).toLocaleString();
          const isWhite = game.white.username === username;
          const result = isWhite ? game.white.result : game.black.result;
          const opponent = isWhite ? game.black.username : game.white.username;

          let resText = '';
          if (result === 'win') resText = 'Victoire';
          else if (result === 'loss') resText = 'Défaite';
          else if (result === 'draw') resText = 'Nulle';
          else resText = 'N/A';

          gamesHTML += `
            <tr>
              <td>${date}</td>
              <td>${resText}</td>
              <td>${opponent}</td>
            </tr>
          `;
        });
        gamesHTML += '</table>';
        document.getElementById('games').innerHTML = gamesHTML;
        gamesSection.style.display = 'block';
      } else {
        document.getElementById('games').innerHTML = '<p>Aucune partie trouvée.</p>';
        gamesSection.style.display = 'block';
      }
    } catch (e) {
      alert('Erreur lors du chargement : ' + e.message);
    } finally {
      showLoader(false);
    }
  }

  select.addEventListener('change', () => {
    fetchAllData(select.value);
  });

  window.onload = init;
</script>


<script src="./userList.js"></script>
</body>
</html>
